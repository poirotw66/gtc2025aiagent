大家好,我是来自快手音视频技术部的袁坤今天我来分享一下快手在提升短视频画质领域的工作内容是重塑短视频视觉体验基于Tensor RT LM加速的智能视频质量评价与处理大模型首先做一下个人介绍我毕业于中科院自动化研究所在CVPR、ICCV、ECCV等国际会议上发表论文20余篇我的主要研究方向包括计算机视觉和深度学习现在我在快手音视频算法中心负责视频质量评价然后以及视频处理相关的算法研究同时也负责一些AI模型的训练部署优化工作然后我们致力于通过提升画质来给用户带来更好的消费体验今天我的分享主要包括四个方面第一是整体介绍一下快手短视频的现状以及生产消费链路第二是快手内部研发的视频质量评价算法KVQ第三是快手研发的视频处理大模型实现极致的画质提升第四是基于英伟达成熟的Tensor RT LM工具来进行部署优化提升服务的推理效率根据最新的财报信息快手平台平均每天的活跃用户达到了4.08亿月活跃用户也达到了7.14亿平均每天用户上传的视频作品的数量达到了3800万日活跃用户也达到了日活跃用户的平均使用时间也达到了132分钟快手名副其实是一个国民的APP快手平台它的玩法是非常多样的然后其中它的内容形式也是非常丰富的就包括了美食风景新闻短剧等等这些视频它在画质上是存在差异的为了更好的提升用户体验我所在的音视频技术部致力于通过AI技术的手段来提升画质为此我们研发了评价增强编码的生产体系在服务端来进行视频的处理其中包括KVQ它是负责衡量快手的视频画质对增强和编码起到监督作用KP和LPM是负责提升视频的画质改善低质丰富细节和纹理KVC则是通过极致的编码压缩降低视频的码率同时保持画质让消费者可以看到更流畅的视频同时节省平台的传输的成本这些算法在快手生产转码的链路中整体是这个样子的就是上传的视频会经过视频分析服务来进行分析然后经过增强修复服务来进行处理最后进行编码除了刚才提到的KVQ KEP和KVC在这些服务体系中也有其他的算子发挥着更犀利度的作用首先我们来介绍一下这个KVQ视频质量评价那么什么是视频质量评价人类视觉系统会根据主观感受评价一段视频的好坏视频质量评价就是希望模拟这种感知通过模型建模给出客观的画质质量粗力度的评价标准可以大概分为五个类从一到五分然后对应画质从差到好KVQ从数据模型训练三个维度来进行优化在数据层面相较于业界开源的这种千级别的数据快手自建了千万级别的UGC的数据用作质量评价的模型训练在模型层面KVQ采用了基于Video Transformer的结构这个结构它可以更加有效的来感知这种时序上共存的不同类型的低质信息相较于以往的CNN结构可以取得更好的效果同时在训练层面我们也引入了质量感知的预训练方式这个方法叫做QPT它可以有效的通过无监督的方式然后通过对比学习的优化损失函数来进行质量感知的模型训练进而可以有效的缓解标注数据匮乏的问题来提升这种常委场景的预测准确率通过这些优化项的话KVQ在公开数据集然后以及快手的数据集上均取得了显著的预测准确性提升下面分别来介绍一下第一个是KVQ就是通过这种预训练的方式在VQA领域走通了大模型中预训练微调的范式像上面这张图我们在预训练阶段经过不同的退化算子来进行处理得到了具有不同湿帧类型的数据然后我们从湿帧图像中裁切出不同区域的图像块来构成样本对其中来自于同一种退化方式并且从不同的图像中裁剪出来的图像块我们把它当作正样本其余的都是副样本包含了内容不同的样本和退化方式不同的样本这些正副样本对会通过对比学习的方式来进行优化使得模型具有了质量感知的能力同时我们也进一步探索了其他的预训练方式就比如通过Mask Image Modeling的方式来让模型获得更有效的质量感知能力第二点就是我们设计了这种质量感知的Transformer结构来进一步提升KBQ的表现它主要是解决这种时序分布中混合视帧类型的感知问题在这个里面我们提出了基于吸收注意力的时序捕捉模块它可以根据视频帧然后以及和整体分布的KL散度来选取关键帧其中KL散度较大的帧它表示跟整体的差异是非常大的说明它的冗余性比较小比较有代表性这些帧会被用来选取出来进行特征表示同时它可以有效地捕捉这种失帧信息降低计算复杂度进一步的我们将上述的这些吸收注意力机制模块来进行并行的处理接收不同长度的视频帧以此来获取时序上不同分布的低质然后这些帧数较少的片段它其实就对应空间分布中的低质比如说噪声和压缩这种它可以在较少的帧就可以识别出来然后帧数较长的片段它可能对应的就是时序上存在的低质分布就比如说是一些运动模糊或者是卡顿等等然后由于我们前面提到的高效的吸收注意力机制多个模块的并行依然可以保持比较高的推理效率通过这种结构建模的方式我们在公开的数据集然后以及快手场景下均取得了比较明显的提升在数据层面我们通过快手线上的生产转码链路来进行原始的数据构建形成了海量的快手标准同时也通过一些这种退化的方式然后无监督的来生成视频序列的相对质量关系在这其中我们考虑了视频的各个锤类就包括这种影视美食短剧新闻然后采用线上一致的处理方式就包括我们会模拟线上这种多阶的湿帧类型多阶的处理然后以及编码链路通过这种方式我们最终形成了千万级别的这种数据来进行模型的训练通过这个算法和服务的双重优化我们的KVQ最终落地了各种各样的业务取得了显著的收益举两个简单的例子第一个是我们用它来指导最优的编码参数基于KVQ分数我们在编码算法它在预编码的阶段可以转出不同参数的视频可以画出RD Curl并且根据这个曲线中的信息来进行决策比如它可以选择同等码率下画质更优的或者选择同等画质下码率更优的视频来进行下发节省带宽的成本或者说是提升画质第二个是我们可以做一些端云协同的后处理我们在服务端模拟移动端的后处理效果来计算它对应的KVQ的分数如果经过后处理之后视频的画质超过原始的更高码率的视频那我们可以在下发阶段下发次一级码率的视频在移动端的时候去做后处理进而节省这个带宽的成本通过KVQ我们可以有效监控快手的视频为了进一步改善视频的画质我下面将介绍一下另外一个工作就是使用LPM这种处理大模型来进行视频的增强处理这里主要介绍一下我们使用生成式的模型来进行增强处理的一些比较新的探索相较于以往使用干Base的方法它的这种画质提升的效果尤其是这种Diffusion Base的方法它能够在主观效果上生成更好的图像同时它的细节纹理会更加的丰富它在架构上是区别于现有的纹生图的模型就包括展示的这个LDM的工作处理大模型更多的是进行这种涂到图的这种增强修复如何有效的引入低分辨率的图像或者说是低清的图像作为状态信息是十分重要的我们团队也在这方面做了很多的尝试和探索最终我们形成了一套以DIT模型为基础模型然后通过Ctrl-Night架构引入低清图像作为这个状态信息的模型架构这种方式它可以有效的兼顾处理任务所需要的保证度和生成任务本身的画质提升其中DIT的基模型它能够在预训练阶段使用海量的高质数据来提升模型本身的生成能力Ctrl-Night分支则可以有效的建模这种输入的低清或者说是低分辨率图像的原始信息来提升我们修复之后的保证度最终我们在公开的测试机上取得了非常好的主观效果同时也能够保持保证度效果上我们也在快手场景的数据上来进行了验证相较于传动干贝斯的方法我们在这个细节的纹理上会更加的丰富真实就比如说这张图片人像中的这些皮肤的细节包括头发丝都可以非常的清晰它的结构也保持的非常好这张图片展示了是树叶的纹理相较于原图的话可以有一个明显的细节提升同时它也符合基本的物理规律做到了高保真的效果Diffusion模型它有一个缺点就是推理的时间太长了然后这主要是由于它依赖于较长的推理部署就比如说DDPM它可能要几百上千步然后DDPM要40到50步然后Rflow的话也要25步为了进一步的提升这个推理的效率让我们的服务能够处理更多的视频的话我们其实在这个里面引入了一致性模型然后通过蒸馏的方式可以有效的将推理部署降低到一步然后就相当于相较于Rflow25步我们加速了整整25倍同时保持它的这种生成的细节然后以及保证度没有较大的损失进一步的我们也结合英伟达提供的TNT-LM部署工具来进行优化一方面我们使用TNT-LM包含的算子优化计算图优化以及一些Flash Attention的优化技术加速DIT和Ctrl-Night这种Transformer的结构在保持主客观画质指标的基础上我们可以有效的通过TRT的部署将它的推理速度提升3.6倍另外我们也引入了先进的FP8退理方式利用新的英伟达GPU的架构的计算单元相较于Int8能够有效的提升量化的效果使得量化前后画质基本没有损失整体可以累积前面的这种加速可以达到整体5.8倍的推理速度的提升这就是我这次的分享感兴趣的可以添加快手技术团队的公众号或者与我进行联系谢谢大家